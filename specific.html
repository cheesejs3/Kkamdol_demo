<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@12/swiper-bundle.min.css"/>
    <script src="https://cdn.jsdelivr.net/npm/swiper@12/swiper-bundle.min.js"></script>

    <title></title>
    <style>
    * { margin: 0; box-sizing: border-box; }
    
    /* â­ï¸â­ï¸â­ï¸ ë¸Œë¼ìš°ì € ìƒˆë¡œê³ ì¹¨ ë°©ì§€ (í•„ìˆ˜ ìœ ì§€) â­ï¸â­ï¸â­ï¸ */
    html, body {
        height: 100%;
        width: 100%;
        overflow: hidden !important; 

        overscroll-behavior: none !important;
    }

    /* â­ï¸ ìˆœìˆ˜ CSS ìŠ¤í¬ë¡¤ ìŠ¤ëƒ… ì»¨í…Œì´ë„ˆ â­ï¸ */
    .swiper {
        width: 100vw;
        height: 100vh;
        background-color: black;
        
        /* ğŸ”¥ ê°€ì¥ ì¤‘ìš”: ìŠ¤í¬ë¡¤ ëª¨ë“œë¥¼ ìˆ˜í‰ìœ¼ë¡œ ì„¤ì •í•˜ê³  ìŠ¤ëƒ…ì„ ê°•ì œ */
        overflow-x: scroll;
        overflow-y: hidden; /* ìˆ˜ì§ ìŠ¤í¬ë¡¤ ë°©ì§€ */
        scroll-snap-type: x mandatory; /* ìˆ˜í‰ ìŠ¤í¬ë¡¤ ìŠ¤ëƒ… ê°•ì œ */
        
        /* iOS í™˜ê²½ ì•ˆì •í™” (ì„ íƒ ì‚¬í•­) */
        -webkit-overflow-scrolling: touch; 
    }
    
    /* â­ï¸ ìŠ¬ë¼ì´ë“œ ë˜í¼ â­ï¸ */
    .swiper-wrapper {
        display: flex; /* ìŠ¬ë¼ì´ë“œë¥¼ ê°€ë¡œë¡œ ë‚˜ì—´ */
        width: max-content; /* ëª¨ë“  ìŠ¬ë¼ì´ë“œê°€ ì°¨ì§€í•˜ëŠ” ì´ ë„ˆë¹„ */
        height: 100%;
    }
    
    /* â­ï¸ ê°œë³„ ìŠ¬ë¼ì´ë“œ â­ï¸ */
    .swiper-slide {
        /* ë·°í¬íŠ¸ ë„ˆë¹„ë§Œí¼ ê° ìŠ¬ë¼ì´ë“œ ë„ˆë¹„ë¥¼ ì„¤ì • */
        width: 100vw; 
        height: 100vh;
        
        /* ğŸ”¥ ê°€ì¥ ì¤‘ìš”: ê° ìŠ¬ë¼ì´ë“œê°€ ìŠ¤í¬ë¡¤ ìŠ¤ëƒ… ì§€ì ì´ ë˜ë„ë¡ ì„¤ì • */
        scroll-snap-align: center; 
        
        /* ë‚´ë¶€ ì´ë¯¸ì§€/ë¹„ë””ì˜¤ ì¤‘ì•™ ì •ë ¬ */
        display: flex;
        align-items: center; 
        justify-content: center;
        flex-shrink: 0; /* ìŠ¬ë¼ì´ë“œê°€ ì¤„ì–´ë“¤ì§€ ì•Šë„ë¡ ë°©ì§€ */
    }
    
    img, video {
        width: 100%;
        height: 100%;
        object-fit: contain;
    }
    
    .info-overlay{
        color:white;
        position: fixed;
        top:0;
        left: 0;
        display: none;Â 
        padding: 10px;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 10;
    }
</style>

</head>
<body>
    <div class="swiper swiper-container">
        <div class="swiper-wrapper" id="swiper-wrapper-id">
             </div>

    </div>
    

<script>
    // ----------------------------------------------------
    // [1] í™˜ê²½ ì„¤ì • (Cloudinary ì •ë³´)
    // ----------------------------------------------------
    const CLOUDINARY_CLOUD_NAME = 'dbmdkatry'; // â­ï¸ ì‚¬ìš©ìì˜ Cloud Name
    const CLOUDINARY_BASE_URL = `https://res.cloudinary.com/${CLOUDINARY_CLOUD_NAME}/`;
    
    const JSON_FILE_PATH = 'photos.json'; 
    //ìƒˆë¡œ ìƒì„±ëœ Swiper ê°ì²´ë¥¼ ì´ ë³€ìˆ˜ì— ì €ì¥í•˜ì—¬, ì´ì œë¶€í„° ìŠ¤í¬ë¦½íŠ¸ì˜ ì–´ëŠ ê³³ì—ì„œë“  globalSwiper.slideNext() ë“±ìœ¼ë¡œ ìŠ¬ë¼ì´ë”ë¥¼ ì œì–´í•  ìˆ˜ ìˆê²Œ ë©ë‹ˆë‹¤.
    let globalSwiper = null; 

    // ----------------------------------------------------
    // [2] í•¨ìˆ˜ ì •ì˜ ì˜ì—­
    // ----------------------------------------------------

    /** URLì—ì„œ 'date' ì¿¼ë¦¬ íŒŒë¼ë¯¸í„°ë¥¼ ì¶”ì¶œí•˜ëŠ” í•¨ìˆ˜ */
    function getInitialDateFromUrl() {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get('date'); 

    }

    /** íŒŒì¼ëª… ë¬¸ìì—´ì„ ë¶„ì„í•˜ì—¬ ë°ì´í„° ê°ì²´ë¡œ ë³€í™˜í•˜ëŠ” í•¨ìˆ˜ */
    function parseFilename(filename) {
        if (typeof filename !== 'string' || filename.length === 0) {
            console.error("íŒŒì¼ëª… ë°ì´í„°ê°€ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤:", filename);
            return null;
        }

        // íŒŒì¼ëª…ì—ì„œ í™•ì¥ìë¥¼ ì œì™¸í•œ ë¶€ë¶„ë§Œ ì¶”ì¶œ
        const basename = filename.substring(0, filename.lastIndexOf('.'));
        const parts = basename.split('_');

        if (parts.length < 5) {
            console.error("íŒŒì¼ëª… í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤:", filename);
            return null;
        }

        const [datePart, timePart, locationPart, peoplePart, actionPart] = parts;
        
        let time;
        if (timePart.length === 2) {
            time = `${timePart}:00:00`;
        } else if (timePart.length === 6) {
            time = `${timePart.substring(0, 2)}:${timePart.substring(2, 4)}:${timePart.substring(4, 6)}`;
        } else {
            time = timePart; 
        }

        const locationSplit = locationPart.split('-');
        const locationSubcategory = locationSplit.length > 1 ? locationSplit[1] : locationSplit[0];

        const people = peoplePart.split('-').join(', ');

        const actionSplit = actionPart.split('-');
        const action = actionSplit[0] || 'N/A';
        const emotion = actionSplit[1] || 'N/A';
        const situation = actionSplit[2] || 'N/A';

        return {
            filename: filename,
            date: datePart,
            time: time,
            locationSubcategory: locationSubcategory,
            people: people,
            action: action,
            emotion: emotion,
            situation: situation
        };
    }

/** Swiper ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì´ˆê¸°í™”í•˜ëŠ” í•¨ìˆ˜ */
function initializeSwiper(initialIndex = 0) {
    if (globalSwiper) {
        globalSwiper.destroy(true, true);
    }
    
    globalSwiper = new Swiper('.swiper', {
        loop: false, 
        slidesPerView: 1,
        spaceBetween: 30,
        allowTouchMove: true,
        initialSlide: initialIndex,
        
        // â­ï¸â­ï¸â­ï¸ ë©”ëª¨ë¦¬ ê´€ë¦¬ë¥¼ ìœ„í•œ Lazy Loading ì˜µì…˜ (í•µì‹¬) â­ï¸â­ï¸â­ï¸
        lazy: {
            loadPrevNext: true, // ì´ì „/ë‹¤ìŒ ìŠ¬ë¼ì´ë“œë¥¼ ë¡œë“œ
            loadPrevNextAmount: 1, // ë¡œë“œí•  ìŠ¬ë¼ì´ë“œ ê°œìˆ˜ë¥¼ 1ê°œë¡œ ì œí•œí•˜ì—¬ ë©”ëª¨ë¦¬ ì‚¬ìš© ìµœì†Œí™”
            loadOnTransitionStart: true,
        },
        
        // â­ï¸ í„°ì¹˜ ì•ˆì •í™” ì˜µì…˜ ìœ ì§€ â­ï¸
        touchStartPreventDefault: true, 
        touchMoveStopPropagation: true, 
        resistance: false,

        // â­ï¸â­ï¸â­ï¸ ë¹„ë””ì˜¤ ì¬ìƒ/ì •ì§€ ì´ë²¤íŠ¸ ì¶”ê°€ (í•µì‹¬) â­ï¸â­ï¸â­ï¸
        on: {
            slideChangeTransitionStart: function () {
                // ëª¨ë“  ìŠ¬ë¼ì´ë“œì˜ ë¹„ë””ì˜¤ë¥¼ ì¼ì‹œì •ì§€í•˜ê³  ì‹œê°„ì„ 0ìœ¼ë¡œ ë¦¬ì…‹
                this.slides.forEach(slide => {
                    const video = slide.querySelector('video');
                    if (video) {
                        video.pause();
                        // video.currentTime = 0; // ì„ íƒ ì‚¬í•­: ë©”ëª¨ë¦¬ í•´ì œì— ë„ì›€
                    }
                });
            },
            slideChangeTransitionEnd: function () {
                // í˜„ì¬ í™œì„± ìŠ¬ë¼ì´ë“œì˜ ë¹„ë””ì˜¤ë§Œ ì¬ìƒ ì‹œë„
                const activeSlide = this.slides[this.activeIndex];
                const video = activeSlide.querySelector('video');
                if (video) {
                    // â­ï¸â­ï¸â­ï¸ ë¹„ë””ì˜¤ ì¤€ë¹„ ì™„ë£Œ í›„ ì¬ìƒ ì‹œë„ â­ï¸â­ï¸â­ï¸
                    // ë¸Œë¼ìš°ì €ì—ê²Œ ë¯¸ë””ì–´ ë¡œë“œê°€ ì™„ë£Œë  ë•Œê¹Œì§€ ê¸°ë‹¤ë¦¬ë¼ê³  ëª…ì‹œì ìœ¼ë¡œ ì•Œë ¤ì¤ë‹ˆë‹¤.
                    
                    if (video.readyState >= 3) { // 3ì€ HAVE_FUTURE_DATAë¥¼ ì˜ë¯¸ (ì¬ìƒí•  ì¤€ë¹„ê°€ ëœ ìƒíƒœ)
                        video.play().catch(e => console.log("Video Play Error (Ready):", e));
                    } else {
                        // ì•„ì§ ë¡œë“œë˜ì§€ ì•Šì•˜ë‹¤ë©´, canplay ì´ë²¤íŠ¸ê°€ ë°œìƒí•˜ë©´ ì¬ìƒí•˜ë„ë¡ ë¦¬ìŠ¤ë„ˆë¥¼ ë¶™ì…ë‹ˆë‹¤.
                        video.addEventListener('canplay', function playOnce() {
                            this.play().catch(e => console.log("Video Play Error (CanPlay):", e));
                            this.removeEventListener('canplay', playOnce); // í•œ ë²ˆë§Œ ì‹¤í–‰ë˜ë„ë¡ ë¦¬ìŠ¤ë„ˆ ì œê±°
                        });
                    }
                }
            }
        }
    });
}

    /** íŒŒì¼ ëª©ë¡ì„ ê¸°ë°˜ìœ¼ë¡œ Swiper ìŠ¬ë¼ì´ë“œ HTMLì„ ìƒì„±í•˜ê³  ì‚½ì…í•˜ëŠ” í•¨ìˆ˜ */
function generateSwiperSlides(filenames) {
    const swiperWrapper = document.getElementById('swiper-wrapper-id');
    let swiperSlidesHTML = '';

    filenames.forEach(filename => {
        const data = parseFilename(filename);

        if (data) {
            const isVideo = filename.toLowerCase().endsWith('.webm');
            
            // Cloudinary URL ìƒì„±: ?cb=1 (Cache Buster) ìœ ì§€
            const resourceType = isVideo ? 'video' : 'image';
            const imagePath = `${CLOUDINARY_BASE_URL}${resourceType}/upload/${filename}?cb=1`; 
            
            let mediaTag;

            if (isVideo) {
                // â­ï¸â­ï¸â­ï¸ data-srcì™€ swiper-lazy í´ë˜ìŠ¤ ì¬ì‚¬ìš© (í•µì‹¬) â­ï¸â­ï¸â­ï¸
                mediaTag = `
                    <video data-src="${imagePath}"  
                            alt="${data.date} - ${data.locationSubcategory}" 
                            controls  
                            muted  
                            loop 
                            playsinline
                            preload="auto" class="swiper-lazy"
                            style="width: 100%; height: 100%; object-fit: contain;">
                        Your browser does not support the video tag.
                    </video>
                    <div class="swiper-lazy-preloader"></div>
                `;
            } else {
                // <img> íƒœê·¸ë„ data-srcì™€ swiper-lazy í´ë˜ìŠ¤ ì¬ì‚¬ìš©
                mediaTag = `
                    <img data-src="${imagePath}"  
                         alt="${data.date} - ${data.locationSubcategory}"
                         class="swiper-lazy"
                         style="width: 100%; height: 100%; object-fit: contain;">
                    <div class="swiper-lazy-preloader"></div>
                `;
            }

                const slideHTML = `
                    <div class="swiper-slide">
                        ${mediaTag} 
                        <div class="info-overlay">
                            <p><strong>ë‚ ì§œ</strong>: ${data.date}</p>
                            <p><strong>ì‹œê°„</strong>: ${data.time}</p>
                            <p><strong>ì¥ì†Œ</strong>: ${data.locationSubcategory}</p>
                            <p><strong>ì‚¬ëŒ</strong>: ${data.people}</p>
                            <p><strong>í–‰ë™</strong>: ${data.action}</p>
                            <p><strong>ê°ì •</strong>: ${data.emotion}</p>
                            <p><strong>ìƒí™©</strong>: ${data.situation}</p>
                        </div>
                    </div>
                `;
                swiperSlidesHTML += slideHTML;
            }
        });

        swiperWrapper.innerHTML = swiperSlidesHTML;
    }


    // ----------------------------------------------------
    // [3] ë©”ì¸ ì‹¤í–‰ ë¡œì§ ì˜ì—­
    // ----------------------------------------------------

    document.addEventListener('DOMContentLoaded', () => {
        const loadingIndicator = document.getElementById('swiper-wrapper-id');
        loadingIndicator.innerHTML = `
            <div class="swiper-slide" style="color:white; font-size: 20px; display:flex; justify-content:center; align-items:center;">
                <p>ë°ì´í„° ë¡œë”© ì¤‘...</p>
            </div>`;


        fetch(JSON_FILE_PATH)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(loadedFilenames => {
                if (Array.isArray(loadedFilenames) && loadedFilenames.length > 0) {
                    
                    const initialDate = getInitialDateFromUrl(); 
                    let initialIndex = 0; 

                    if (initialDate) {
                        const firstMatchingIndex = loadedFilenames.findIndex(filename => {
                            return filename.substring(0, 10) === initialDate;
                        });
                        
                        if (firstMatchingIndex !== -1) {
                            initialIndex = firstMatchingIndex;
                        }
                    }

                    // 1. ìŠ¬ë¼ì´ë“œ HTML ìƒì„±
                    generateSwiperSlides(loadedFilenames);
                    
                    // 2. Swiper ì´ˆê¸°í™”
                    initializeSwiper(initialIndex);
                    
                } else {
                    console.error("JSON íŒŒì¼ì— ìœ íš¨í•œ íŒŒì¼ëª… ë°°ì—´ì´ ì—†ê±°ë‚˜ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤.");
                    loadingIndicator.innerHTML = '<div class="swiper-slide" style="color:red; font-size: 20px;">ì˜¤ë¥˜: JSON íŒŒì¼ì´ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤.</div>';
                }
            })
            .catch(error => {
                console.error("JSON íŒŒì¼ ë¡œë”© ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
                loadingIndicator.innerHTML = 
                    `<div class="swiper-slide" style="color:red; font-size: 20px; padding: 20px; text-align: center;">
                        ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: ${error.message}
                        <p style="font-size: 0.8em; margin-top: 10px;">(Cloudinary Public ID, ` + JSON_FILE_PATH + ` ê²½ë¡œ í™•ì¸ í•„ìš”)</p>
                    </div>`;
            });
    });
</script>
</body>
</html>
