<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <meta name="theme-color" content="#000000">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    
    <meta name="apple-mobile-web-app-status-bar-style" content="black"> 
    

    <title>Pure JS Image Slider</title>
    <style>
    * { margin: 0; box-sizing: border-box; }
    
    html, body {
        /* â­ï¸â­ï¸â­ï¸ ìµœì¢… ë°©ì–´: ë·°í¬íŠ¸ ì™„ì „ ê³ ì • (ìœ ì§€) â­ï¸â­ï¸â­ï¸ */
        height: 100% !important; 
        width: 100% !important;
        position: fixed; 
        top: 0;
        left: 0;
        overscroll-behavior: none !important;
        overflow: hidden !important;         
    }

    /* â­ï¸ ìŠ¬ë¼ì´ë“œ ì»¨í…Œì´ë„ˆ (ìœ ì§€) â­ï¸ */
    .swiper {
        width: 100vw;
        height: 100vh;
        min-height: 100svh;
        background-color: black;
        overflow: hidden !important; 
        touch-action: none !important; 
    }
    
    /* â­ï¸ ìŠ¬ë¼ì´ë“œ ë˜í¼ (ìœ ì§€) â­ï¸ */
    .swiper-wrapper {
        display: flex; 
        height: 100%; 
        width: max-content; 
        transition: transform 0.3s ease-out; 
    }
    
    /* â­ï¸ ê°œë³„ ìŠ¬ë¼ì´ë“œ (ìœ ì§€) â­ï¸ */
    .swiper-slide {
        width: 100vw; 
        height: 100%; 
        display: flex;
        align-items: center; 
        justify-content: center;
        flex-shrink: 0; 
        padding: 0 16px; 
    }
    
    img, video {
        width: 100%;
        height: 100%;
        object-fit: contain;
        -webkit-user-drag: none;
        user-select: none;
    }
    
    .info-overlay{
        color:white;
        position: fixed;
        top:0;
        left: 0;
        display: none; /* JSë¡œ ì œì–´ë¨: í‰ì†Œ ìˆ¨ê¹€ */
        padding: 10px;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 10;
    }
</style>

</head>
<body>
    <div class="swiper">
        <div class="swiper-wrapper" id="swiper-wrapper-id">
        </div>
    </div>
    
<script>
    // ----------------------------------------------------
    // [1] í™˜ê²½ ì„¤ì • ë° ë³€ìˆ˜
    // ----------------------------------------------------
    const CLOUDINARY_CLOUD_NAME = 'dbmdkatry';
    const CLOUDINARY_BASE_URL = `https://res.cloudinary.com/${CLOUDINARY_CLOUD_NAME}/`;
    const JSON_FILE_PATH = 'photos.json'; 
    
    let isDragging = false;
    let startX = 0;
    let currentTranslate = 0;
    let currentIndex = 0;
    let slideCount = 0;
    
    let wrapper = null; 
    
    // â­ï¸â­ï¸â­ï¸ ìƒˆë¡œìš´ ë³€ìˆ˜: í„°ì¹˜(íƒ­)ë¡œ ê°„ì£¼í•  ìµœëŒ€ ì´ë™ ê±°ë¦¬ (í”½ì…€) â­ï¸â­ï¸â­ï¸
    const TAP_THRESHOLD = 10; 

    // ----------------------------------------------------
    // [2] ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜
    // ----------------------------------------------------

    /** URLì—ì„œ 'date' ì¿¼ë¦¬ íŒŒë¼ë¯¸í„°ë¥¼ ì¶”ì¶œí•˜ëŠ” í•¨ìˆ˜ (ìœ ì§€) */
    function getInitialDateFromUrl() {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get('date'); 
    }

    /** íŒŒì¼ëª… ë¬¸ìì—´ì„ ë¶„ì„í•˜ì—¬ ë°ì´í„° ê°ì²´ë¡œ ë³€í™˜í•˜ëŠ” í•¨ìˆ˜ (ìœ ì§€) */
    function parseFilename(filename) {
        if (typeof filename !== 'string' || filename.length === 0) {
            return null;
        }
        const basename = filename.substring(0, filename.lastIndexOf('.'));
        const parts = basename.split('_');
        if (parts.length < 5) {
            return null;
        }
        const [datePart, timePart, locationPart, peoplePart, actionPart] = parts;
        let time;
        if (timePart.length === 2) {
            time = `${timePart}:00:00`;
        } else if (timePart.length === 6) {
            time = `${timePart.substring(0, 2)}:${timePart.substring(2, 4)}:${timePart.substring(4, 6)}`;
        } else {
            time = timePart; 
        }
        const locationSplit = locationPart.split('-');
        const locationSubcategory = locationSplit.length > 1 ? locationSplit[1] : locationSplit[0];
        const people = peoplePart.split('-').join(', ');
        const actionSplit = actionPart.split('-');
        const action = actionSplit[0] || 'N/A';
        const emotion = actionSplit[1] || 'N/A';
        const situation = actionSplit[2] || 'N/A';

        return {
            filename: filename,
            date: datePart,
            time: time,
            locationSubcategory: locationSubcategory,
            people: people,
            action: action,
            emotion: emotion,
            situation: situation
        };
    }

    /** íŒŒì¼ ëª©ë¡ì„ ê¸°ë°˜ìœ¼ë¡œ ìŠ¬ë¼ì´ë“œ HTMLì„ ìƒì„±í•˜ê³  ì‚½ì…í•˜ëŠ” í•¨ìˆ˜ (ìœ ì§€) */
    function generateSwiperSlides(filenames) {
        let swiperSlidesHTML = '';

        filenames.forEach(filename => {
            const data = parseFilename(filename);

            if (data) {
                const isVideo = filename.toLowerCase().endsWith('.webm') || filename.toLowerCase().endsWith('.mp4');
                const resourceType = isVideo ? 'video' : 'image'; 
                const dataPath = `${CLOUDINARY_BASE_URL}${resourceType}/upload/${filename}`; 
                
                let mediaTag;

                if (isVideo) {
                    const posterFilename = filename.replace(/\.[^/.]+$/, '.jpg'); 
                    const posterPath = `${CLOUDINARY_BASE_URL}video/upload/f_jpg/${posterFilename}`;
                    
                    mediaTag = `
                        <video 
                            data-src="${dataPath}"  
                            data-poster="${posterPath}"
                            muted  
                            loop 
                            preload="metadata" 
                            playsinline
                            aria-label="${data.date} - ${data.locationSubcategory}"
                            style="width: 100%; height: 100%; object-fit: contain;"
                            class="video-media"
                        >
                            Your browser does not support the video tag.
                        </video>
                    `;
                } else {
                    mediaTag = `
                        <img data-src="${dataPath}"  
                             alt="${data.date} - ${data.locationSubcategory}"
                             style="width: 100%; height: 100%; object-fit: contain;">
                    `;
                }
                
                const slideHTML = `
                    <div class="swiper-slide">
                        ${mediaTag} 
                        <div class="info-overlay">
                            <p><strong>ë‚ ì§œ</strong>: ${data.date}</p>
                            <p><strong>ì‹œê°„</strong>: ${data.time}</p>
                            <p><strong>ì¥ì†Œ</strong>: ${data.locationSubcategory}</p>
                            <p><strong>ì‚¬ëŒ</strong>: ${data.people}</p>
                            <p><strong>í–‰ë™</strong>: ${data.action}</p>
                            <p><strong>ê°ì •</strong>: ${data.emotion}</p>
                            <p><strong>ìƒí™©</strong>: ${data.situation}</p>
                        </div>
                    </div>
                `;
                swiperSlidesHTML += slideHTML;
            }
        });

        wrapper.innerHTML = swiperSlidesHTML;
    }


    // ----------------------------------------------------
    // [3] JS ìŠ¬ë¼ì´ë“œ í•µì‹¬ ë¡œì§ ë° ë¹„ë””ì˜¤ ì œì–´
    // ----------------------------------------------------
    
    // transform CSS ì—…ë°ì´íŠ¸ í•¨ìˆ˜ (ìœ ì§€)
    function setWrapperTranslate(x) {
        if(wrapper) {
            wrapper.style.transform = `translateX(${x}px)`;
        }
    }
    
    /** ë¹„ë””ì˜¤ í„°ì¹˜ ì‹œ Controlsì™€ ì˜¤ë²„ë ˆì´ë¥¼ í† ê¸€í•©ë‹ˆë‹¤. (ìœ ì§€) */
    function toggleVideoControls(slideElement) {
        const video = slideElement.querySelector('video');
        const overlay = slideElement.querySelector('.info-overlay');
        
        if (!video) return;

        // Controls í† ê¸€
        const hasControls = video.hasAttribute('controls');
        if (hasControls) {
            video.removeAttribute('controls');
            overlay.style.display = 'none';
        } else {
            video.setAttribute('controls', '');
            overlay.style.display = 'block';
        }
    }

    /** ì§€ì •ëœ ìŠ¬ë¼ì´ë“œì˜ ë¯¸ë””ì–´(img/video)ë¥¼ ë¡œë“œí•©ë‹ˆë‹¤. (ìœ ì§€) */
    function loadMedia(slideElement) {
        const media = slideElement.querySelector('img, video');
        if (!media) return;

        if ((media.tagName === 'VIDEO' || media.tagName === 'IMG') && media.getAttribute('data-src') && !media.hasAttribute('src')) {
            const dataSrc = media.getAttribute('data-src');
            
            media.setAttribute('src', dataSrc);
            
            if (media.tagName === 'VIDEO' && media.hasAttribute('data-poster')) {
                media.setAttribute('poster', media.getAttribute('data-poster'));
            }
            
            media.removeAttribute('data-src');
            media.removeAttribute('data-poster');
        }
    }


    /** ì£¼ë³€ ìŠ¬ë¼ì´ë“œì˜ ë¯¸ë””ì–´ë¥¼ ë¡œë“œí•˜ê³  ë¹„ë””ì˜¤ ì¬ìƒ ìƒíƒœë¥¼ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤. */
    function updateMediaState() {
        const slides = wrapper.querySelectorAll('.swiper-slide');
        
        slides.forEach((slide, index) => {
            const video = slide.querySelector('video');
            const isCurrent = index === currentIndex;
            
            // í˜„ì¬ ìŠ¬ë¼ì´ë“œ ë° ì£¼ë³€ 2ê°œ ìŠ¬ë¼ì´ë“œê¹Œì§€ ë¡œë“œ (ìœ ì§€)
            const isNeighbor = Math.abs(index - currentIndex) <= 2; 
            
            // 1. ë¯¸ë””ì–´ ë¡œë”© (ì§€ì—° ë¡œë”©)
            if (isNeighbor) {
                loadMedia(slide); 
            }

            // 2. ì¬ìƒ/ì •ì§€ ë° UI ì²˜ë¦¬
            if (video) {
                if (isCurrent) {
                    // video.load()ëŠ” srcë¥¼ ì„¤ì •í•œ í›„ í˜¸ì¶œë˜ì–´ì•¼ ë¯¸ë””ì–´ê°€ ì¤€ë¹„ë¨
                    video.load(); 
                    
                    // ìŠ¤ì™€ì´í”„ í›„ ìë™ ì¬ìƒ ë° UI ìˆ¨ê¹€
                    video.play().catch(e => console.log("Video Play Error (Index:", index, "):", e));
                    video.removeAttribute('controls'); 
                    slide.querySelector('.info-overlay').style.display = 'none'; 

                } else {
                    video.pause();
                    video.removeAttribute('controls'); 
                    slide.querySelector('.info-overlay').style.display = 'none';
                }
            }
        });
    }

    // ìŠ¬ë¼ì´ë“œ ì´ë™ (í„°ì¹˜ ì¢…ë£Œ ì‹œ ìŠ¤ëƒ…) (ìœ ì§€)
    function snapToSlide(draggedDistance) {
        const threshold = 0.25; 
        const slideWidth = wrapper.offsetWidth / slideCount;
        
        // ì´ë™í•  ì¸ë±ìŠ¤ ê³„ì‚°
        if (Math.abs(draggedDistance) > slideWidth * threshold) {
            if (draggedDistance > 0 && currentIndex < slideCount - 1) { 
                currentIndex++; 
            } else if (draggedDistance < 0 && currentIndex > 0) { 
                currentIndex--; 
            }
        }
        
        currentTranslate = -currentIndex * slideWidth;
        setWrapperTranslate(currentTranslate);
        
        updateMediaState(); 
    }
    
    // ----------------------------------------------------
    // [4] ìˆœìˆ˜ JavaScript í„°ì¹˜ í•¸ë“¤ëŸ¬ (ìˆ˜ì •)
    // ----------------------------------------------------
    
    function handleTouchStart(e) {
        startX = e.touches[0].clientX;
        isDragging = true;
        wrapper.style.transition = 'none';
    }

    function handleTouchMove(e) {
        if (!isDragging) return;
        const deltaX = e.touches[0].clientX - startX;
        setWrapperTranslate(currentTranslate + deltaX);
    }

    function handleTouchEnd(e) {
        if (!isDragging) return;
        
        isDragging = false;
        wrapper.style.transition = 'transform 0.3s ease-out';
        
        const endX = e.changedTouches[0].clientX;
        const draggedDistance = startX - endX; 
        
        // ğŸ”¥ğŸ”¥ í•µì‹¬ ìˆ˜ì •: ë“œë˜ê·¸ ê±°ë¦¬ê°€ TAP_THRESHOLD ì´í•˜ì´ë©´ ìŠ¬ë¼ì´ë“œ ì´ë™ ë¡œì§ì„ ê±´ë„ˆëœë‹ˆë‹¤. ğŸ”¥ğŸ”¥
        if (Math.abs(draggedDistance) < TAP_THRESHOLD) {
             // íƒ­ìœ¼ë¡œ ì¸ì‹: ìŠ¬ë¼ì´ë“œ ì´ë™(snapToSlide) ëŒ€ì‹  ë¹„ë””ì˜¤ UI í† ê¸€ì€ click ì´ë²¤íŠ¸ê°€ ì²˜ë¦¬í•©ë‹ˆë‹¤.
             // ì•„ë¬´ ì‘ì—…ë„ í•˜ì§€ ì•Šê³  ë¦¬í„´í•˜ì—¬ ìŠ¬ë¼ì´ë“œ ìœ„ì¹˜ë¥¼ ê³ ì •í•©ë‹ˆë‹¤.
             currentTranslate = -currentIndex * wrapper.offsetWidth / slideCount;
             setWrapperTranslate(currentTranslate);
             return; 
        }

        // ë“œë˜ê·¸ë¡œ ì¸ì‹: ìŠ¬ë¼ì´ë“œ ì´ë™ ë¡œì§ ì‹¤í–‰
        snapToSlide(draggedDistance);
    }


    // ----------------------------------------------------
    // [5] ë©”ì¸ ì‹¤í–‰ ë¡œì§ ì˜ì—­
    // ----------------------------------------------------

    document.addEventListener('DOMContentLoaded', () => {
        
        wrapper = document.getElementById('swiper-wrapper-id');
        
        // í„°ì¹˜ í•¸ë“¤ëŸ¬ ì„¤ì • (ìœ ì§€)
        wrapper.addEventListener('touchstart', handleTouchStart, { passive: false });
        wrapper.addEventListener('touchmove', handleTouchMove, { passive: false });
        wrapper.addEventListener('touchend', handleTouchEnd);
        
        const loadingIndicator = wrapper; 
        loadingIndicator.innerHTML = `
            <div class="swiper-slide" style="color:white; font-size: 20px; display:flex; justify-content:center; align-items:center;">
                <p>ë°ì´í„° ë¡œë”© ì¤‘...</p>
            </div>`;


        fetch(JSON_FILE_PATH)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(loadedFilenames => {
                if (Array.isArray(loadedFilenames) && loadedFilenames.length > 0) {
                    
                    slideCount = loadedFilenames.length;
                    
                    // 1. ìŠ¬ë¼ì´ë“œ HTML ìƒì„±
                    generateSwiperSlides(loadedFilenames);
                    
                    // 2. ì´ˆê¸° ìŠ¬ë¼ì´ë“œ ìœ„ì¹˜ ì„¤ì •
                    const initialDate = getInitialDateFromUrl(); 
                    if (initialDate) {
                        const firstMatchingIndex = loadedFilenames.findIndex(filename => filename.substring(0, 10) === initialDate);
                        if (firstMatchingIndex !== -1) {
                            currentIndex = firstMatchingIndex;
                        }
                    }

                    // 3. ëª¨ë“  ë¹„ë””ì˜¤ ìš”ì†Œì— í„°ì¹˜(í´ë¦­) ë¦¬ìŠ¤ë„ˆ ì¶”ê°€ (ìœ ì§€)
                    const slides = wrapper.querySelectorAll('.swiper-slide');
                    slides.forEach(slide => {
                        const video = slide.querySelector('video');
                        if (video) {
                            video.addEventListener('click', (e) => {
                                // ë“œë˜ê·¸ ë¡œì§ê³¼ ì¶©ëŒ ë°©ì§€
                                e.stopPropagation(); 
                                // í„°ì¹˜ ì‹œ UI í† ê¸€ ì‹¤í–‰
                                toggleVideoControls(slide);
                            });
                        }
                    });
                    
                    // 4. ì´ˆê¸° ìœ„ì¹˜ ê³„ì‚° ë° ë¯¸ë””ì–´ ìƒíƒœ ì—…ë°ì´íŠ¸
                    window.requestAnimationFrame(() => {
                        const slideWidth = wrapper.offsetWidth / slideCount; 
                        currentTranslate = -currentIndex * slideWidth;
                        setWrapperTranslate(currentTranslate);
                        
                        // ì´ˆê¸° ë¯¸ë””ì–´ ë¡œë“œ ë° ì¬ìƒ ìƒíƒœ ì—…ë°ì´íŠ¸ í˜¸ì¶œ
                        updateMediaState(); 
                    });
                    
                } else {
                    console.error("JSON íŒŒì¼ì— ìœ íš¨í•œ íŒŒì¼ëª… ë°°ì—´ì´ ì—†ê±°ë‚˜ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤.");
                    loadingIndicator.innerHTML = '<div class="swiper-slide" style="color:red; font-size: 20px;">ì˜¤ë¥˜: JSON íŒŒì¼ì´ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤.</div>';
                }
            })
            .catch(error => {
                console.error("JSON íŒŒì¼ ë¡œë”© ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
                loadingIndicator.innerHTML = 
                    `<div class="swiper-slide" style="color:red; font-size: 20px; padding: 20px; text-align: center;">
                        ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: ${error.message}
                        <p style="font-size: 0.8em; margin-top: 10px;">(Cloudinary Public ID, ` + JSON_FILE_PATH + ` ê²½ë¡œ í™•ì¸ í•„ìš”)</p>
                    </div>`;
            });
    });
</script>
</body>
</html>
